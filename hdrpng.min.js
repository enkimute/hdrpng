var HDRImage=function(){function t(){var t,e,h=document.createElement("canvas"),s="t",u=1,d=2.2,f=null;return h.__defineGetter__("exposure",function(){return u}),h.__defineSetter__("exposure",function(n){u=n,f&&(o(f,u,d,e.data),t.putImageData(e,0,0))}),h.__defineGetter__("gamma",function(){return d}),h.__defineSetter__("gamma",function(n){d=n,f&&(o(f,u,d,e.data),t.putImageData(e,0,0))}),h.__defineGetter__("dataFloat",function(){return r(f)}),h.__defineGetter__("dataRGBE",function(){return f}),h.toHDRDataURL=function(){t&&t.clearRect(0,0,this.width,this.height),a(f,e.data),t.globalCompositeOperation="copy",t.putImageData(e,0,0);var n=this.toDataURL();return o(f,u,d,e.data),t.putImageData(e,0,0),n},h.__defineGetter__("src",function(){return s}),h.__defineSetter__("src",function(r){if(s=r,t&&t.clearRect(0,0,this.width,this.height),r.match(/\.hdr$/i))n(r,function(n,r,a){f=n,this.width=this.style.width=r,this.height=this.style.height=a,t=this.getContext("2d"),e=t.getImageData(0,0,r,a),o(n,u,d,e.data),t.putImageData(e,0,0),this.onload&&this.onload()}.bind(h));else if(r.match(/\.hdr\.png$/i)){var a=new Image;a.src=r,a.onload=function(){this.width=this.style.width=a.width,this.height=this.style.height=a.height,t=this.getContext("2d"),t.globalCompositeOperation="copy",t.drawImage(a,0,0),e=t.getImageData(0,0,this.width,this.height),f=i(e.data),o(f,u,d,e.data),t.putImageData(e,0,0),this.onload&&this.onload()}.bind(this)}}),h}function e(t,e){for(var n in e)t[n]=e[n];return t}function n(t,n){var r=e(new XMLHttpRequest,{responseType:"arraybuffer"});return r.onerror=n.bind(r,!1),r.onload=function(){if(this.status>=400)return this.onerror();for(var t,e="",r=0,a=new Uint8Array(this.response);!e.match(/\n\n[^\n]+\n/g);)e+=String.fromCharCode(a[r++]);if(t=e.match(/FORMAT=(.*)$/m)[1],"32-bit_rle_rgbe"!=t)return console.warn("unknown HDR format : "+t),this.onerror();for(var i=e.split(/\n/).reverse()[1].split(" "),o=("-Y"==i[0],1*i[3]),h=1*i[1],s=new Uint8Array(o*h*4),u=0,d=0;h>d;d++){var f=a.slice(r,r+=4),l=[];if(2!=f[0]||2!=f[1]||128&f[2])return console.warn("HDR not rle encoded while it should be .."),this.onerror();if(f[2]<<8+f[3]!=o)return console.warn("HDR with invalid scanline length .."),this.onerror();for(var c=0;4>c;c++)for(var g,_,m=c*o,p=(c+1)*o;p>m;)if(g=a.slice(r,r+=2),g[0]>128)for(_=g[0]-128;_-->0;)l[m++]=g[1];else for(_=g[0]-1,l[m++]=g[1];_-->0;)l[m++]=a[r++];for(var c=0;o>c;c++)s[u++]=l[c],s[u++]=l[c+o],s[u++]=l[c+2*o],s[u++]=l[c+3*o]}n&&n(s,o,h)},r.open("GET",t,!0),r.send(null),r}function r(t,e){for(var n,r=t.byteLength>>2,e=e||new Float32Array(3*r),a=0;r>a;a++)n=Math.pow(2,t[4*a+3]-136),e[3*a]=t[4*a]*n,e[3*a+1]=t[4*a+1]*n,e[3*a+2]=t[4*a+2]*n;return e}function a(t,e){for(var n=t.byteLength>>2,e=e||new Uint8ClampedArray(4*n),r=0;n>r;r++)e[4*r]=223*t[4*r]/255,e[4*r+1]=223*t[4*r+1]/255,e[4*r+2]=223*t[4*r+2]/255,e[4*r+3]=224+Math.min(31,Math.max(0,t[4*r+3]-128+16));return e}function i(t,e){for(var n=t.byteLength>>2,e=e||new Uint8ClampedArray(4*n),r=0;n>r;r++)e[4*r]=255*t[4*r]/223,e[4*r+1]=255*t[4*r+1]/223,e[4*r+2]=255*t[4*r+2]/223,e[4*r+3]=(31&t[4*r+3])-16+128;return e}function o(t,e,n,r){e=Math.pow(2,void 0===e?1:e)/2,void 0===n&&(n=2.2);for(var a,i=1/n,o=t.byteLength>>2,r=r||new Uint8ClampedArray(4*o),h=0;o>h;h++)a=e*Math.pow(2,t[4*h+3]-136),r[4*h]=255*Math.pow(t[4*h]*a,i),r[4*h+1]=255*Math.pow(t[4*h+1]*a,i),r[4*h+2]=255*Math.pow(t[4*h+2]*a,i),r[4*h+3]=255;return r}return t.loadHDR=n,t.rgbeToFloat=r,t.rgbeToLDR=o,t}();